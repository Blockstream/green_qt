.macos-arm64:
  extends:
    - .macos
  variables:
    PREFIX: "$CI_PROJECT_DIR/depends/macos-arm64"
    ARCH: "arm64"
    PKG_CONFIG_PATH: "$PREFIX/lib/pkgconfig"
    CMAKE_INSTALL_PREFIX: "$PREFIX"
    gdk_ROOT: "$PREFIX/lib/arm64-apple-darwin/gdk"
  cache:
    key: macos_arm64_28
    paths: [depends/]
  tags:
    - macos-arm64

macos-arm64:depends:
  extends:
    - .macos-arm64
    - .depends

macos-arm64:build:
  extends:
    - .macos-arm64
    - .build
  after_script:
    - mkdir macos-arm64
    - mv build/"Blockstream.app" macos-arm64
  artifacts:
    name: "$CI_PROJECT_NAME-$CI_JOB_NAME-$CI_COMMIT_SHORT_SHA"
    expire_in: 1 week
    paths:
      - macos-arm64/Blockstream.app
  when: manual

macos-arm64:staple:
  extends:
    - .macos:staple
  artifacts:
    name: "$CI_PROJECT_NAME-$CI_JOB_NAME-$CI_COMMIT_SHORT_SHA"
    expire_in: 1 week
    when: always
    paths:
      - "macos-arm64/Blockstream.app"
      - "macos-arm64/Blockstream.dmg"
  needs:
    - macos-arm64:build
  script:
    - mv macos-arm64/Blockstream.app Blockstream.app
    - tools/macos-staple.sh Blockstream.app
    - tools/packdmg.sh Blockstream.app
    - tools/macos-staple.sh Blockstream.dmg
    - mv Blockstream.app Blockstream.dmg macos-arm64/
