package-shared:build:
  tags:
    - garelease
  stage: package
  variables:
    GIT_STRATEGY: none
  artifacts:
    name: "$CI_PROJECT_NAME-$CI_JOB_NAME-$CI_COMMIT_SHORT_SHA"
    expire_in: 1 week
    paths:
    - $CI_PROJECT_DIR/package.tar.gz
    when: on_success
  script:
    - cd $CI_PROJECT_DIR
    - rm -fr dist
    - mkdir dist
    - mv BlockstreamSetup.exe dist/BlockstreamSetup-x86_64.exe
    - mv macos-arm64-shared/Blockstream.dmg dist/Blockstream-arm64.dmg
    - mv macos-x86_64-shared/Blockstream.dmg dist/Blockstream-x86_64.dmg
    - mv macos-universal-shared/Blockstream.dmg dist/Blockstream-universal.dmg
    - chmod +x linux-x86_64-shared/Blockstream-x86_64.AppImage
    - mv linux-x86_64-shared/Blockstream-x86_64.AppImage dist
    - cd dist
    - /opt/process_release
    - cat SHA256SUMS.asc
    - cd ..
    - tar czf package.tar.gz dist
  needs:
    - linux-x86_64-shared:build-appimage
    - macos-arm64-shared:staple
    - macos-x86_64-shared:staple
    - macos-universal-shared:staple
    - windows-x86_64-shared:sign-installer

.publish-shared:
  tags:
    - ga
  stage: package
  when: manual
  needs:
    - package-shared:build
  image: glregistry.blockstream.io/blockstream/p/gcloud-docker:tf0.15.4
  script:
    - tar zxvf package.tar.gz
    - cd dist
    - ../tools/publish.sh

package-shared:publish-rc:
  extends:
    - .publish-shared
  variables:
    CHANNEL: rc

package-shared:publish-latest:
  extends:
    - .publish-shared
  variables:
    CHANNEL: latest
  only:
    - tags
  except:
    - branches
