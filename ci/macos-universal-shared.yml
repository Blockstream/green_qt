macos-universal-shared:build:
  tags:
    - osxsigner
  stage: build
  artifacts:
    name: "$CI_PROJECT_NAME-$CI_JOB_NAME-$CI_COMMIT_SHORT_SHA"
    expire_in: 1 week
    paths:
      - macos-universal-shared/Blockstream.app
  needs:
    - macos-arm64-shared:build
    - macos-x86_64-shared:build
  script:
    - mkdir macos-universal-shared
    - cp -R macos-x86_64-shared/Blockstream.app macos-universal-shared/
    - lipo -create -output macos-universal-shared/Blockstream.app/Contents/MacOS/Blockstream macos-arm64-shared/Blockstream.app/Contents/MacOS/Blockstream macos-x86_64-shared/Blockstream.app/Contents/MacOS/Blockstream

macos-universal-shared:staple:
  extends:
    - .macos:staple
  artifacts:
    name: "$CI_PROJECT_NAME-$CI_JOB_NAME-$CI_COMMIT_SHORT_SHA"
    expire_in: 1 week
    when: always
    paths:
      - macos-universal-shared/Blockstream.app
      - macos-universal-shared/Blockstream.dmg
  needs:
    - macos-universal-shared:build
  script:
    - mv macos-universal-shared/Blockstream.app Blockstream.app
    - tools/macos-staple.sh Blockstream.app
    - tools/packdmg.sh Blockstream.app
    - tools/macos-staple.sh Blockstream.dmg
    - mv Blockstream.app Blockstream.dmg macos-universal-shared/
  when: on_success
