.macos-arm64-shared:
  variables:
    PREFIX: "$CI_PROJECT_DIR/depends/macos-arm64-shared"
    HOST: "macos"
    ARCH: "arm64"
    SHA256SUM: "shasum -a 256"
    PKG_CONFIG_PATH: "$PREFIX/lib/pkgconfig"
    CMAKE_INSTALL_PREFIX: "$PREFIX"
    gdk_ROOT: "$PREFIX/lib/arm64-apple-darwin/gdk"
    MACOSX_DEPLOYMENT_TARGET: 12.0
  cache:
    key: macos_arm64_shared_2
    paths: [depends/]
  before_script:
    - export PATH="$HOME/qt-install/6.8.3/macos/bin/:$PATH"
  tags:
    - macos-arm64

macos-arm64-shared:depends:
  stage: depends
  extends:
    - .macos-arm64-shared
  script:
    - if [ -d $PREFIX ]; then
        echo "using cached depends";
        exit 0;
      fi
    - tools/buildkdsingleapplication.sh
    - tools/buildlibserialport.sh
    - tools/buildlibusb.sh
    - tools/buildhidapi.sh
    - tools/buildcountly.sh
    - tools/buildzxing.sh
    - tools/buildbreakpad.sh
    - tools/buildcrashpad.sh
    - tools/buildgdk.sh
    - tools/buildgpgme.sh

macos-arm64-shared:build:
  extends:
    - .build
    - .macos-arm64-shared
  needs: ["macos-arm64-shared:depends"]
  after_script:
    - $HOME/qt-install/6.8.3/macos/bin/macdeployqt build/Blockstream.app -qmldir=qml
    - rm -rf build/Blockstream.app/Contents/MacOS/Blockstream.dSYM
    - mkdir macos-arm64-shared
    - mv build/Blockstream.app macos-arm64-shared
  artifacts:
    name: "$CI_PROJECT_NAME-$CI_JOB_NAME-$CI_COMMIT_SHORT_SHA"
    expire_in: 1 week
    paths:
      - macos-arm64-shared/Blockstream.app

macos-arm64-shared:staple:
  tags:
    - osxsigner
  stage: staple
  artifacts:
    name: "$CI_PROJECT_NAME-$CI_JOB_NAME-$CI_COMMIT_SHORT_SHA"
    expire_in: 1 week
    when: always
    paths:
      - macos-arm64-shared/Blockstream.app
      - macos-arm64-shared/Blockstream.dmg
  needs: ["macos-arm64-shared:build"]
  script:
    - mv macos-arm64-shared/Blockstream.app Blockstream.app
    - tools/macos-staple.sh Blockstream.app
    - tools/packdmg.sh Blockstream.app
    - tools/macos-staple.sh Blockstream.dmg
    - mv Blockstream.app Blockstream.dmg macos-arm64-shared/
